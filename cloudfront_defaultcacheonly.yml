Resources:
  GenoVicCloudFrontDistribution:
    Type: 'AWS::CloudFront::Distribution'
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
        - DomainName: alfredhealth.genovic.org.au
          Id: alfredhealth
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: austinhealth.genovic.org.au
          Id: austinhealth
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: labtec.genovic.org.au
          Id: labtechealth
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: monashhealth.genovic.org.au
          Id: monashhealth
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: rmh.genovic.org.au
          Id: rmh
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: rmhtest.genovic.org.au
          Id: rmhtest
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: vcgs.genovic.org.au
          Id: vcgs
          OriginPath: /
          CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
        - DomainName: vcgstest.genovic.org.au
          Id: vcgstest
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: data.genovic.org.au
          Id: dataportal
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        - DomainName: clinical.genovic.org.au
          Id: clinicalportal
          OriginPath: /
          CustomOriginConfig:
            HTTPSPort: 443
            OriginProtocolPolicy: https-only
        DefaultCacheBehavior: 
          AllowedMethods: 
            - GET
            - HEAD
            - OPTIONS
            - PUT
          CachedMethods: 
            - GET
            - HEAD
          MaxTTL: 300
          TargetOriginId: alfredhealth
          ViewerProtocolPolicy: redirect-to-https
        ViewerCertificate:
          AcmCertificateArn: !Ref GenoVicWildCardCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2018
        WebACLId: !Ref GenoVicWaf
  
  GenoVicWildCardCertificate:
    Type: 'AWS::CertificateManager::Certificate'
    Properties:
      DomainName: '*.genovic.org.au'
      SubjectAlternativeNames:
        - genovic.org.au
        - www.genovic.org.au
        - test.internal.genovic.org.au
        - devdaniel.sandbox.genovic.org.au
  
  GenoVicWaf:
    Type: 'AWS::WAFv2::WebACL'
    Properties:
      Name: GenoVic-waf
      Scope: CLOUDFRONT
      DefaultAction:
          Block: {}
      VisibilityConfig:
        CloudWatchMetricsEnabled: true
        MetricName: genovic-waf-metric
        SampledRequestsEnabled: true
      Rules:
      - Name: AWSManagedRulesCommonRuleSet
        Statement:
          ManagedRuleGroupStatement: 
           VendorName: AWS
           Name: CommonRuleSet    
        Priority: 1
        Action:
          Block: {}
        OverrideAction:
          Count: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: CommonRuleSetMetric    
      - Name: AWSManagedRulesSQLiRuleSet
        Statement:
         ManagedRuleGroupStatement:
           VendorName: AWS
           Name: SQLiRuleSet
        Priority: 2
        Action:
          Block: {}
        OverrideAction:
          Count: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: SQLiMetric
      - Name: AWSManagedRulesKnownBadInputs
        Statement:
          ManagedRuleGroupStatement:
            Name: BadInputSet
            VendorName: AWS
        Priority: 3
        Action:
          Block: {}
        OverrideAction:
          Count: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: BadInputMetric
      - Name: AWSManagedRulesATPRuleSet
        Statement:
          ManagedRuleGroupStatement:
            Name: ATPRuleSet
            VendorName: AWS
        Priority: 4
        Action:
          Block: {}
        OverrideAction:
          Count: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: ATPRuleSetMetric
      - Name: AWSManagedRulesIPReputationList
        Priority: 5
        Statement:
          ManagedRuleGroupStatement:
            Name: IPReputationListSet
            VendorName: AWS
        Action:
          Block: {}
        OverrideAction:
          Count: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: IPReputationListMetric
      - Name: AWSManagedRulesBotControlRuleSet
        Priority: 6
        Statement:
          ManagedRuleGroupStatement:
            Name: BotControlSet
            VendorName: AWS
        Action:
          Block: {}
        OverrideAction:
          Count: {}
        VisibilityConfig:
          SampledRequestsEnabled: true
          CloudWatchMetricsEnabled: true
          MetricName: BotControlSetMetric
    
  